---
- job:
    name: 'firmware-firmware-pull-request'
    project-type: freestyle
    defaults: global
    description: 'Generated by job-builder'
    display-name: 'freifunk firmware pull requests'
    quiet-period: 5
    scm:
      - git:
          url: https://github.com/lynxis/firmware
          branches:
            - ${ghprbActualCommit}
          refspec: +refs/pull/*:refs/remotes/origin/pr/*
          wipe-workspace: false
          git-config-name: 'Jenkins Builder'
          git-config-email: 'admax@fe80.eu'
    triggers:
        - github-pull-request:
            github-hooks: true
            permit-all: false
            org-list:
              - firmware-berlin
    publishers:
        - github-notifier
    properties:
      - github:
          url: https://github.com/lynxis/firmware
    builders:
      - trigger-builds:
        - project:
            - freifunk-firmware
          predefined-parameters: |
              UPLOAD_DIR=unstable/${BUILD_NUMBER}
              ARCH=ar71xx
              GIT_BRANCH=${ghprbActualCommit}
              GIT_REFSPEC=+refs/pull/*:refs/remotes/origin/pr/*
        - project:
            - freifunk-firmware
          predefined-parameters: |
              UPLOAD_DIR=unstable/${BUILD_NUMBER}
              ARCH=ar71xx_mikrotik
              GIT_BRANCH=${ghprbActualCommit}
              GIT_REFSPEC=+refs/pull/*:refs/remotes/origin/pr/*
        - project:
            - freifunk-firmware
          predefined-parameters: |
              UPLOAD_DIR=unstable/${BUILD_NUMBER}
              ARCH=mpc85xx
              GIT_BRANCH=${ghprbActualCommit}
              GIT_REFSPEC=+refs/pull/*:refs/remotes/origin/pr/*
        - project:
            - freifunk-firmware
          predefined-parameters: |
              UPLOAD_DIR=unstable/${BUILD_NUMBER}
              ARCH=ramips
              GIT_BRANCH=${ghprbActualCommit}
              GIT_REFSPEC=+refs/pull/*:refs/remotes/origin/pr/*
        - project:
            - freifunk-firmware
          predefined-parameters: |
              UPLOAD_DIR=unstable/${BUILD_NUMBER}
              ARCH=x86
              GIT_BRANCH=${ghprbActualCommit}
              GIT_REFSPEC=+refs/pull/*:refs/remotes/origin/pr/*

- job:
    name: 'freifunk-firmware'
    project-type: freestyle
    defaults: global
    description: 'Generated by job-builder'
    display-name: 'freifunk firmware unstable'
    quiet-period: 5
    builders:
      - shell:
          !include-raw: freifunk-firmware.sh
    scm:
      - git:
          url: https://github.com/freifunk-berlin/firmware
          branches:
            - ${GIT_BRANCH}
          refspec: ${GIT_REFSPEC}
          wipe-workspace: false
          git-config-name: 'Jenkins Builder'
          git-config-email: 'admax@fe80.eu'
    publishers:
        - warnings:
            workspace-file-scanners:
              - file-pattern: 'openwrt/logs/**'
                scanner: 'GNU Make + GNU C Compiler (gcc)'
            run-always: true
            only-use-stable-builds-as-reference: true
        - ssh:
            site: 'freifunk'
            target: '${UPLOAD_DIR}'
            source: 'firmwares/'
        - github-notifier
    properties:
      - github:
          url: https://github.com/freifunk-berlin/firmware
    parameters:
      - string:
          name: ARCH
          default: ar71xx_generic
          description: "Build for this architecture. E.g. ar71xx_generic"
      - string:
          name: GIT_REFSPEC
          default: "master"
          description: "The exact revspec to fetch. Empty is also possible"
      - string:
          name: GIT_BRANCH
          default: "master"
          description: "The branch to built. Can be also a commit."
      - string:
          name: UPLOAD_DIR
          default: "unstable/manual-${BUILD_NUMBER}"
          description: "Under which name the resulting build is uploaded"
